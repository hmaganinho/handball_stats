<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handball Stats Elite v13.1</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyB0rZbDY86-jzfpWljDQ_HyhqAXbwO89Y0",
        authDomain: "handball-scout.firebaseapp.com",
        databaseURL: "https://handball-scout-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "handball-scout",
        storageBucket: "handball-scout.firebasestorage.app",
        messagingSenderId: "787055965645",
        appId: "1:787055965645:web:c81ec090c1f68af0d20084"
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      window._fbSet = (path, data) => set(ref(db, path), data);
      window._fbReady = true;
    </script>
    <style>
        :root {
            --verde: #28a745; --vermelho: #dc3545; --azul: #007bff;
            --laranja: #fd7e14; --amarelo: #ffc107; --cinza: #333; --escuro: #000; --roxo: #6f42c1;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #111; color: white; padding-bottom: 50px; text-align: center; }
        
        #topo { position: sticky; top: 0; z-index: 100; background: var(--escuro); box-shadow: 0 4px 15px rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
        #marcador { display: flex; justify-content: space-around; align-items: center; padding: 10px; }
        .score { font-size: 36px; font-weight: bold; font-family: monospace; }
        #tempo { font-size: 36px; color: var(--amarelo); font-family: monospace; font-weight: bold; }

        #equipa-stats { display: flex; gap: 4px; padding: 10px; background: #222; }
        .btn-destaque { flex: 1; padding: 10px 2px; border-radius: 5px; background: var(--azul); text-align: center; }
        .val-destaque { display: block; font-size: 18px; font-weight: bold; }
        .label-destaque { display: block; font-size: 9px; opacity: 0.9; text-transform: uppercase; }

        section { padding: 12px; border-bottom: 1px solid #333; max-width: 500px; margin: 0 auto; }
        h3 { font-size: 11px; color: #777; text-transform: uppercase; margin: 5px 0; }

        .grid-jogadores { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-jogador { 
            background: var(--cinza); border: 2px solid #444; 
            height: 60px; font-size: 24px; font-weight: bold;
            color: white; border-radius: 6px; position: relative;
            opacity: 0.3; transition: 0.2s;
        }
        .btn-jogador.no-campo { opacity: 1; border-color: var(--verde); box-shadow: inset 0 0 10px var(--verde); }
        .btn-jogador.is-gr { background: var(--roxo); }
        .btn-jogador.selecionado { background: var(--azul) !important; opacity: 1 !important; border-color: #fff !important; transform: scale(1.05); }
        .gm-label { position: absolute; top: 2px; right: 4px; font-size: 11px; font-weight: bold; color: #fff; opacity: 0.95; }

        .btn-staff { background: var(--cinza); padding: 12px; font-size: 21px; border: 0px solid #666; opacity: 0.7; color: white; border-radius: 6px; }
        .btn-staff.selecionado { background: var(--azul) !important; border-color: #fff; opacity: 1; }

        .linha-controlo { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-fluxo { flex: 1; padding: 15px; font-size: 14px; font-weight: bold; border-radius: 8px; border: 2px solid #444; background: #222; color: white; cursor: pointer; }
        .btn-fluxo.ativo { background: var(--verde); border-color: white; }

        .grid-zonas { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .btn-zona { background: var(--azul); padding: 18px 0; font-size: 21px; font-weight: bold; border-radius: 4px; color: white; border: none; }
        .btn-zona.selecionada { background: #fff; color: var(--azul); outline: 2px solid var(--azul); }

        .grid-acoes { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-acao { padding: 18px 5px; font-size: 21px; font-weight: bold; border-radius: 6px; color: white; border: none; text-transform: uppercase; }

        .container-tabela { width: 100%; overflow-x: auto; margin-top: 10px; background: #111; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: #222; padding: 8px; color: #888; }
        td { padding: 8px; border-bottom: 1px solid #222; }

        #custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 30px; border-radius: 12px; border: 1px solid #444; width: 80%; max-width: 300px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    
        /* Timer Controls */
        .timer-controls { display: flex; gap: 10px; align-items: center; justify-content: center; margin-top: 8px; }
        .btn-timer { padding: 8px 18px; font-size: 20px; border: none; border-radius: 6px; cursor: pointer; background: var(--verde); color: white; font-weight: bold; min-width: 50px; transition: 0.2s; }
        .btn-timer.stop { background: var(--vermelho); }
        .btn-timer:active { transform: scale(0.95); }
        .btn-timer.disabled { opacity: 0.4; pointer-events: none; }

        /* Baliza */
        #zona-baliza-container {
            display: none; 
            margin: 15px auto; 
            max-width: 320px; 
            text-align: center;
            animation: fadeIn 0.3s;
        }
        .baliza-frame {
            background: repeating-linear-gradient(45deg, #cc0000, #cc0000 10px, #ffffff 10px, #ffffff 20px);
            padding: 10px;
            padding-bottom: 0;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        .baliza-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            background: #ccc;
            border: 2px solid #333;
            border-bottom: none;
        }
        .baliza-cell {
            background: rgba(255, 255, 255, 0.9);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: 0.2s;
        }
        .baliza-cell:hover { background: #ffeb3b; }
        .baliza-cell:active { background: #4caf50; color: white; transform: scale(0.95); }
        .baliza-titulo { color: #fff; margin-bottom: 5px; font-size: 14px; text-transform: uppercase; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Status dos Jogadores (Visual) */
        .status-am { border-color: #ffeb3b !important; box-shadow: 0 0 5px #ffeb3b !important; color: #ffeb3b !important; }
        .status-2m-1 { border-color: #fd7e14 !important; box-shadow: 0 0 8px #fd7e14 !important; }
        .status-2m-2 { border-color: #dc3545 !important; box-shadow: 0 0 10px #dc3545 !important; }

        #modal-setup{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.96);z-index:2000;justify-content:center;align-items:center;}
        .setup-box{background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:28px 20px;width:92%;max-width:380px;}
        .setup-box h2{margin:0 0 4px;font-size:20px;color:white;text-align:center;}
        .setup-subtitulo{font-size:10px;color:#555;text-align:center;text-transform:uppercase;letter-spacing:2px;margin-bottom:20px;}
        .setup-row label{display:block;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
        .setup-row input{width:100%;padding:10px 12px;background:#111;border:1px solid #333;border-radius:6px;color:white;font-size:14px;box-sizing:border-box;}
        .setup-row input:focus{outline:none;border-color:var(--azul);}
        .setup-2col{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
        .equipa-nos input{border-left:3px solid var(--verde)!important;}
        .equipa-eles input{border-left:3px solid var(--vermelho)!important;}
        .btn-setup{width:100%;padding:15px;background:var(--azul);color:white;border:none;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;margin-top:8px;}
        #barra-jogo{background:#0a0a0a;border-bottom:1px solid #1a1a1a;padding:5px 10px;text-align:center;font-size:11px;color:#555;display:none;}
        .btn-editar-jogo{position:fixed;bottom:14px;right:14px;background:#1a1a1a;border:1px solid #333;color:#666;font-size:11px;padding:7px 12px;border-radius:6px;cursor:pointer;z-index:500;}
        /* Labels dentro do bot√£o */
        .eficacia-label { position: absolute; bottom: 2px; right: 4px; font-size: 10px; opacity: 0.8; color: #ccc; }
        .m2-dot { position: absolute; top: 2px; right: 4px; font-size: 10px; font-weight: bold; color: #fd7e14; }
</style>
</head>
<body>

<div id="modal-setup">
  <div class="setup-box">
    <h2>‚õæ Handball Scout</h2>
    <div class="setup-subtitulo">Configura√ß√£o do Jogo</div>
    <div class="setup-2col">
      <div class="setup-row"><label>N¬∫ do Jogo</label><input type="text" id="s-id" placeholder="Ex: 047"></div>
      <div class="setup-row"><label>Data</label><input type="date" id="s-data"></div>
    </div>
    <div class="setup-2col">
      <div class="setup-row"><label>Hora</label><input type="time" id="s-hora"></div>
      <div class="setup-row"><label>Local</label><input type="text" id="s-local" placeholder="Pavilh√£o..."></div>
    </div>
    <div class="setup-2col">
      <div class="setup-row equipa-nos"><label>üü¢ A Nossa Equipa</label><input type="text" id="s-nos" placeholder="Nome da equipa"></div>
      <div class="setup-row equipa-eles"><label>üî¥ Advers√°rio</label><input type="text" id="s-eles" placeholder="Advers√°rio"></div>
    </div>
    <button class="btn-setup" onclick="guardarSetup()">‚ñ∂ INICIAR JOGO</button>
  </div>
</div>
<div id="barra-jogo"></div>
<button class="btn-editar-jogo" onclick="abrirEditarJogo()">‚úèÔ∏è Jogo</button>
<div id="topo">
    <div id="marcador">
        <div style="text-align:center">
            <div id="label-nos" style="font-size:11px;color:var(--verde);font-weight:bold;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">N√ìS</div>
            <div class="score" id="p-nos" style="color:var(--verde)">0</div>
        </div>
        <div style="text-align:center">
            <div id="tempo">00:00</div>
            <div class="timer-controls">
                <button onclick="startTempo()" id="btn-play" class="btn-timer" title="Iniciar">‚ñ∂</button>
                <button onclick="stopTempo()" id="btn-stop" class="btn-timer stop disabled" title="Parar">‚è∏</button>
            </div>
        </div>
        <div style="text-align:center">
            <div id="label-eles" style="font-size:11px;color:var(--vermelho);font-weight:bold;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">ELES</div>
            <div class="score" id="p-eles" style="color:var(--vermelho)">0</div>
        </div>
    </div>
    <div id="equipa-stats">
        <div class="btn-destaque"><span class="label-destaque">EO</span><span class="val-destaque" id="eo-val">0%</span></div>
        <div class="btn-destaque" style="background:#5c6bc0;"><span class="label-destaque">ED</span><span class="val-destaque" id="ed-val">0%</span></div>
        <div class="btn-destaque" style="background:var(--roxo);"><span class="label-destaque">Efic√°cia GR</span><span class="val-destaque" id="gr-val">0%</span></div>
    </div>
</div>

<div id="resumo-selecao" style="background:#1a1a1a; padding:10px; color:var(--amarelo); font-size:14px; font-weight:bold;">JOGADOR: -- | ZONA: --</div>

<section>
    <div class="linha-controlo">
        <button id="btn-7-inicial" class="btn-fluxo" onclick="ativarModo('7inicial')">üìã 7 INICIAL</button>
        <button id="btn-sub" class="btn-fluxo" onclick="ativarModo('sub')">üîÑ SUBSTITUI√á√ÉO</button>
    </div>
    <div class="grid-jogadores" id="grid-main"></div>
    <div class="grid-staff" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
        <button class="btn-staff" id="btn-staff-treinador" onclick="cliqueJogador('TREINADOR')">TREINADOR</button>
        <button class="btn-staff" id="btn-staff-dirigente" onclick="cliqueJogador('DIRIGENTE')">DIRIGENTE</button>
    </div>
</section>

<section>
    <h3>Zonas</h3>
    <div class="grid-zonas">
        <button class="btn-zona" onclick="selecionarZona('PE', this)">PE</button>
        <button class="btn-zona" onclick="selecionarZona('PV', this)">PV</button>
        <button class="btn-zona" onclick="selecionarZona('PD', this)">PD</button>
        <button class="btn-zona" onclick="selecionarZona('LE', this)">LE</button>
        <button class="btn-zona" onclick="selecionarZona('CT', this)">CT</button>
        <button class="btn-zona" onclick="selecionarZona('LD', this)">LD</button>
        <button class="btn-zona" style="grid-column: span 2; margin-top:5px;" onclick="selecionarZona('7 METROS', this)">7 METROS</button>
        <button class="btn-zona" style="grid-column: span 1; margin-top:5px; background: var(--roxo);" onclick="selecionarZona('C-ATAQUE', this)">C-ATAQUE</button>
    </div>
</section>

<section>
    <div class="grid-acoes">
        <button class="btn-acao" style="background:var(--verde);line-height:1.2;" onclick="registar('Golo Marcado')">GOLO<br><span style="font-size:14px">MARCADO</span></button>
        <button class="btn-acao" style="background:var(--vermelho);line-height:1.2;" onclick="registar('Golo Sofrido')">GOLO<br><span style="font-size:14px">SOFRIDO</span></button>
        
        <button class="btn-acao" style="background:var(--verde);line-height:1.2;" onclick="registar('Remate Defendido')">REMATE<br><span style="font-size:14px">DEFENDIDO</span></button>
        <button class="btn-acao" style="background:var(--vermelho);line-height:1.2;" onclick="registar('Remate Falhado')">REMATE<br><span style="font-size:14px">FALHADO</span></button>
        
        <button class="btn-acao" style="background:var(--verde)" onclick="registar('A√ß√£o Defensiva')">A√ß√£o Defensiva</button>
        <button class="btn-acao" style="background:var(--vermelho)" onclick="registar('Falha T√©cnica')">Falha T√©cnica</button>
        
        <button class="btn-acao" style="background:var(--verde)" onclick="registar('7M Sofrido')">7M Sofrido</button>
        <button class="btn-acao" style="background:var(--vermelho)" onclick="registar('7M Cometido')">7M Cometido</button>
        
        <button class="btn-acao" style="background:var(--amarelo); color:black" onclick="registar('C. Amarelo')">C. Amarelo</button>
        <button class="btn-acao" style="background:var(--laranja)" onclick="registar('2 Minutos')">2 Minutos</button>
        <button class="btn-acao" style="grid-column: span 2;background:var(--vermelho)" onclick="registar('C. Vermelho')">Cart√£o Vermelho</button>
    </div>
<div id="zona-baliza-container">
    <div class="baliza-titulo">Selecione Zona da Baliza</div>
    <div class="baliza-frame">
        <div class="baliza-grid">
            <div class="baliza-cell" onclick="confirmarBaliza('A')">A</div>
            <div class="baliza-cell" onclick="confirmarBaliza('B')">B</div>
            <div class="baliza-cell" onclick="confirmarBaliza('C')">C</div>
            <div class="baliza-cell" onclick="confirmarBaliza('D')">D</div>
            <div class="baliza-cell" onclick="confirmarBaliza('F')">F</div>
            <div class="baliza-cell" onclick="confirmarBaliza('G')">G</div>
            <div class="baliza-cell" onclick="confirmarBaliza('H')">H</div>
            <div class="baliza-cell" onclick="confirmarBaliza('I')">I</div>
            <div class="baliza-cell" onclick="confirmarBaliza('J')">J</div>
        </div>
    </div>
    <button onclick="cancelarBaliza()" style="margin-top:10px; background:#444; color:#fff; border:none; padding:5px 15px; border-radius:4px; cursor:pointer;">CANCELAR</button>
</div>

</section>

<section>
    <h3>Jogadores de Campo (Geral)</h3>
    <div class="container-tabela">
        <table>
            <thead><tr><th>N¬∫</th><th>EO%</th><th>GM</th><th>RF</th><th>AD</th><th>FT</th><th>7MS</th><th>7MC</th><th>AM</th><th>2M</th><th>VM</th></tr></thead>
            <tbody id="corpo-stats-field"></tbody>
        </table>
    </div>
</section>

<section>
    <h3>Guarda-Redes (Espec√≠fico)</h3>
    <div class="container-tabela">
        <table>
            <thead>
                <tr>
                    <th>N¬∫</th>
                    <th>GS</th><th>RD</th><th>GR%</th>
                    <th style="border-left:1px solid #444">GS 7m</th><th>RD 7m</th><th>7m%</th>
                    <th style="border-left:1px solid #444">PE%</th><th>PV%</th><th>PD%</th>
                    <th>LE%</th><th>CT%</th><th>LD%</th><th>CA%</th>
                </tr>
            </thead>
            <tbody id="corpo-stats-gr"></tbody>
        </table>
    </div>
</section>

<section style="display: flex; gap: 8px;">
    <button onclick="anularUltimo()" style="background:#444; flex: 1; padding:15px; border-radius:8px; border:none; color:white; font-weight:bold;">‚Ü© ANULAR</button>
    <button onclick="exportarCSV()" style="background:var(--verde); flex: 1; padding:15px; border-radius:8px; border:none; color:white; font-weight:bold;">üíæ EXCEL</button>
    <button onclick="enviarWhatsApp()" style="background:#25D366; flex: 1; padding:15px; border-radius:8px; border:none; color:white; font-weight:bold;">üì± WA</button>
</section>

<div id="custom-modal">
    <div class="modal-content"><p>√â Guarda-Redes?</p><div class="modal-btns"><button class="btn-modal" style="background:var(--verde); color:white" onclick="confirmModal(true)">SIM</button><button class="btn-modal" style="background:var(--vermelho); color:white" onclick="confirmModal(false)">N√ÉO</button></div></div>
</div>

<script>
let jogadores = {}; 
const staffNames = ["TREINADOR", "DIRIGENTE"];
for(let i=1; i<=16; i++) jogadores[i] = { camisola: i, cipa: "------", isGR: false, noCampo: false, gm:0, rf:0, ad:0, ft:0, m7s:0, m7c:0, rd:0, gs:0, am:0, m2:0, vm:0 };
staffNames.forEach(s => jogadores[s] = { cipa: "---", noCampo: true, gm:0, rf:0, ad:0, ft:0, m7s:0, m7c:0, rd:0, gs:0, am:0, m2:0, vm:0 });

let historico = [], jAtivo = null, zAtiva = null, modoAtual = 'scout', segs = 0, timerInterval = null, timerAtivo = false, tempNum = null;

const container = document.getElementById('grid-main');
for(let i=1; i<=16; i++) {
    const btn = document.createElement('button');
    btn.className = 'btn-jogador'; btn.id = `btn-j-${i}`;
    btn.innerHTML = `<span class="gm-label" id="gm-${i}"></span><span id="cam-${i}">${i}</span><span class="m2-dot" id="m2-${i}"></span><span class="eficacia-label" id="eficacia-${i}"></span>`;
    btn.onclick = () => cliqueJogador(i);
    container.appendChild(btn);
}

function ativarModo(m) {
    modoAtual = (modoAtual === m) ? 'scout' : m;
    document.getElementById('btn-7-inicial').classList.toggle('ativo', modoAtual === '7inicial');
    document.getElementById('btn-sub').classList.toggle('ativo', modoAtual === 'sub');
}

function cliqueJogador(num) {
    // S√≥ entra no modo de edi√ß√£o (CIPAs) se o timer estiver a ZERO e NUNCA tiver sido iniciado
    if(!timerAtivo && segs === 0 && modoAtual === 'scout' && typeof num === 'number') {
        const c = prompt(`CIPA para jogador ${num}:`, jogadores[num].cipa);
        const cam = prompt(`Novo n√∫mero da camisola:`, jogadores[num].camisola);
        if(c !== null && cam !== null) { 
            jogadores[num].cipa = c; 
            jogadores[num].camisola = cam;
            const spanCam = document.getElementById(`cam-${num}`);
            if(spanCam) spanCam.innerText = cam;
            tempNum = num; 
            document.getElementById('custom-modal').style.display = 'flex'; 
        }
        return;
    }

    // Modo Campo/Substitui√ß√£o
    if(modoAtual === '7inicial' || modoAtual === 'sub') {
        if(typeof num === 'number') {
            const ativos = Object.values(jogadores).filter(j => j.noCampo && j.cipa !== "---").length;
            if(!jogadores[num].noCampo && ativos >= 7) return alert("Limite 7 jogadores!");
            jogadores[num].noCampo = !jogadores[num].noCampo;
            document.getElementById(`btn-j-${num}`).classList.toggle('no-campo', jogadores[num].noCampo);
        }
    } else {
        // Sele√ß√£o de Jogador para A√ß√£o (Modo Jogo)
        document.querySelectorAll('.btn-jogador, .btn-staff').forEach(b => b.classList.remove('selecionado'));
        jAtivo = num;
        let idAlvo = typeof num === 'number' ? `btn-j-${num}` : `btn-staff-${num.toLowerCase()}`;
        document.getElementById(idAlvo).classList.add('selecionado');
        atualizarLabel();
    }
}

function confirmModal(res) { jogadores[tempNum].isGR = res; document.getElementById(`btn-j-${tempNum}`).classList.toggle('is-gr', res); document.getElementById('custom-modal').style.display = 'none'; }

function selecionarZona(n, btn) {
    document.querySelectorAll('.btn-zona').forEach(b => { b.style.background = 'var(--azul)'; b.style.color = 'white'; });
    zAtiva = (zAtiva === n) ? null : n;
    if(zAtiva) { btn.style.background = 'white'; btn.style.color = 'var(--azul)'; }
    atualizarLabel();
}

function atualizarLabel() { 
    let nomeExibicao = jAtivo;
    if(typeof jAtivo === 'number') nomeExibicao = jogadores[jAtivo].camisola;
    document.getElementById('resumo-selecao').innerText = `JOGADOR: ${nomeExibicao || '--'} | ZONA: ${zAtiva || '--'}`; 
}


        function startTempo() {
            timerAtivo = true;
            if(!timerInterval) {
                timerInterval = setInterval(()=>{
                    segs++;
                    let m = Math.floor(segs/60); let s = segs%60;
                    const tStr = (m<10?'0':'')+m+':'+(s<10?'0':'')+s;
                    document.getElementById('tempo').textContent = tStr;
                    if(window._fbReady) window._fbSet('jogo/tempo', tStr).catch(()=>{});
                }, 1000);
                document.getElementById('btn-play').classList.add('disabled');
                document.getElementById('btn-stop').classList.remove('disabled');
            }
        }

        function stopTempo() {
            if(timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('btn-play').classList.remove('disabled');
                document.getElementById('btn-stop').classList.add('disabled');
            }
        }

        function toggleTempo() { if(!timerInterval) startTempo(); else stopTempo(); }



// Vari√°vel para guardar a a√ß√£o pendente
let acaoPendente = null;

function registar(acao) {
    if(!jAtivo) return alert("Selecione Jogador!");

    // A√ß√µes que ativam a baliza
    const acoesComBaliza = ["Golo Marcado", "Golo Sofrido", "Remate Defendido"];

    if (acoesComBaliza.includes(acao)) {
        acaoPendente = acao;
        const baliza = document.getElementById('zona-baliza-container');
        baliza.style.display = 'block';
        baliza.scrollIntoView({behavior: 'smooth', block: 'nearest'});
    } else {
        processarRegisto(acao, null);
    }
}

function confirmarBaliza(zona) {
    if (acaoPendente) {
        processarRegisto(acaoPendente, zona);
        cancelarBaliza();
    }
}

function cancelarBaliza() {
    acaoPendente = null;
    document.getElementById('zona-baliza-container').style.display = 'none';
}

function processarRegisto(acao, zonaBaliza) {
    const j = jogadores[jAtivo];

    // Contagem de estat√≠sticas
    if(acao === "Golo Marcado") j.gm++;
    else if(acao === "Remate Falhado") j.rf++;
    else if(acao === "A√ß√£o Defensiva") j.ad++;
    else if(acao === "7M Sofrido") { j.m7s++; } 
    else if(acao === "Falha T√©cnica") j.ft++;
    else if(acao === "7M Cometido") { j.m7c++; }
    else if(acao === "Remate Defendido") j.rd++;
    else if(acao === "Golo Sofrido") j.gs++;

    // Disciplinar
    else if(acao === "C. Amarelo") j.am++;
    else if(acao === "2 Minutos") j.m2++;
    else if(acao === "Cart√£o Vermelho") j.vm++;

    // Hist√≥rico com 'zb'
    historico.unshift({ 
        j: jAtivo, 
        cam: j.camisola, 
        a: acao, 
        t: document.getElementById('tempo').innerText, 
        z: zAtiva || "Geral",
        zb: zonaBaliza || "-" 
    });

    atualizarTudo(); 
    resetUI();
}


function atualizarTudo() {
    let tGM=0, tRF=0, tFT=0, tAD=0, tRD=0, tGS=0;

    // Clear both tables
    const tbField = document.getElementById('corpo-stats-field'); tbField.innerHTML = "";
    const tbGR = document.getElementById('corpo-stats-gr'); tbGR.innerHTML = "";

    // Helper to calc percentage
    const calcPct = (num, den) => den > 0 ? Math.round((num/den)*100) : 0;

    for(let i in jogadores) {
        const j = jogadores[i];
        if(!staffNames.includes(i)) { 
            // Global Totals
            tGM+=j.gm; tRF+=j.rf; tFT+=j.ft; tAD+=j.ad; tRD+=j.rd; tGS+=j.gs; 

            // 1. Calc Efic√°cia (EO)
            let efic = 0;
            if (j.isGR) {
                const totalDef = j.rd + j.gs;
                efic = calcPct(j.rd, totalDef);
            } else {
                const totalAtk = j.gm + j.rf;
                efic = calcPct(j.gm, totalAtk);
            }

            // 2. Visual Classes
            const btn = document.getElementById(`btn-j-${i}`);
            if(btn) {
                btn.classList.remove('status-am', 'status-2m-1', 'status-2m-2');
                if (j.m2 >= 2) btn.classList.add('status-2m-2');
                else if (j.m2 === 1) btn.classList.add('status-2m-1');
                else if (j.am > 0) btn.classList.add('status-am');
            }

            // 3. Update Button Labels
            const spanEf = document.getElementById(`eficacia-${i}`);
            if(spanEf) {
                const hasData = (j.isGR && (j.rd+j.gs > 0)) || (!j.isGR && (j.gm+j.rf > 0));
                spanEf.innerText = hasData ? efic + "%" : "";
            }
            const spanM2 = document.getElementById(`m2-${i}`);
            if(spanM2) spanM2.innerText = j.m2 > 0 ? j.m2 : "";
            const spanGM = document.getElementById(`gm-${i}`);
            if(spanGM) spanGM.innerText = j.gm > 0 ? "‚öΩ" + j.gm : "";
            const spanCam = document.getElementById(`cam-${i}`);
            if(spanCam) spanCam.innerText = j.camisola || i;

            // --- FILL FIELD PLAYER TABLE (All players go here) ---
            if((j.gm||0)+(j.rf||0)+(j.ft||0)+(j.ad||0)+(j.rd||0)+(j.gs||0)+(j.am||0)+(j.m2||0)+(j.vm||0)+(j.m7s||0)+(j.m7c||0) > 0) {
                const eo = calcPct(j.gm, j.gm+j.rf+j.ft);
                tbField.innerHTML += `<tr>
                    <td>${j.camisola || i}</td>
                    <td>${eo}%</td>
                    <td>${j.gm}</td>
                    <td>${j.rf}</td>
                    <td>${j.ad}</td>
                    <td>${j.ft}</td>
                    <td>${j.m7s || 0}</td>
                    <td>${j.m7c || 0}</td>
                    <td style="color:var(--amarelo)">${j.am}</td>
                    <td style="color:orange">${j.m2}</td>
                    <td style="color:var(--vermelho)">${j.vm}</td>
                </tr>`;
            }

            // --- FILL GK TABLE (Only if isGR is true) ---
            if (j.isGR) {
                // We need to dig into history for detailed Zone stats for this specific GK
                // Init buckets
                let stats = {
                    gs7m:0, rd7m:0,
                    zones: { 
                        'PE':{gs:0, rd:0}, 'PV':{gs:0, rd:0}, 'PD':{gs:0, rd:0},
                        'LE':{gs:0, rd:0}, 'CT':{gs:0, rd:0}, 'LD':{gs:0, rd:0},
                        'C-ATAQUE':{gs:0, rd:0}, '7 METROS':{gs:0, rd:0} // Temp storage for 7m too
                    }
                };

                // Filter history
                historico.forEach(h => {
                    if (String(h.j) === String(i)) { // Match player ID
                        if (h.a === "Golo Sofrido") {
                            if(h.z === "7 METROS") stats.gs7m++;
                            if(stats.zones[h.z]) stats.zones[h.z].gs++;
                        }
                        else if (h.a === "Remate Defendido") {
                            if(h.z === "7 METROS") stats.rd7m++;
                            if(stats.zones[h.z]) stats.zones[h.z].rd++;
                        }
                    }
                });

                const grTot = calcPct(j.rd, j.rd+j.gs);
                const gr7m = calcPct(stats.rd7m, stats.rd7m+stats.gs7m);

                // Helper for Zone Pct
                const zPct = (zCode) => {
                    const d = stats.zones[zCode];
                    if(!d) return "0%";
                    return calcPct(d.rd, d.rd+d.gs) + "%";
                };

                tbGR.innerHTML += `<tr>
                    <td>${j.camisola || i}</td>
                    <td>${j.gs}</td>
                    <td>${j.rd}</td>
                    <td style="font-weight:bold; color:var(--roxo)">${grTot}%</td>
                    <td style="border-left:1px solid #444">${stats.gs7m}</td>
                    <td>${stats.rd7m}</td>
                    <td style="font-weight:bold">${gr7m}%</td>
                    <td style="border-left:1px solid #444">${zPct('PE')}</td>
                    <td>${zPct('PV')}</td>
                    <td>${zPct('PD')}</td>
                    <td>${zPct('LE')}</td>
                    <td>${zPct('CT')}</td>
                    <td>${zPct('LD')}</td>
                    <td>${zPct('C-ATAQUE')}</td>
                </tr>`;
            }
        }
    }
    document.getElementById('p-nos').innerText = tGM;
    document.getElementById('p-eles').innerText = tGS;
    const eoStr = calcPct(tGM, tGM+tRF+tFT) + "%";
    const edStr = calcPct(tRD+tAD, tRD+tGS+tAD) + "%";
    const grStr = calcPct(tRD, tRD+tGS) + "%";
    document.getElementById('eo-val').innerText = eoStr;
    document.getElementById('ed-val').innerText = edStr;
    document.getElementById('gr-val').innerText = grStr;
    _sincronizarFirebase(tGM, tGS, tRF, tFT, tRD, tAD, eoStr, edStr, grStr);
}

function _sincronizarFirebase(tGM, tGS, tRF, tFT, tRD, tAD, eoStr, edStr, grStr) {
    if(!window._fbReady) return;
    const calcPct = (n,d) => d>0 ? Math.round((n/d)*100) : 0;
    const payload = {
        info: jogoInfo || {},
        marcador: { nos: tGM, eles: tGS },
        tempo: document.getElementById('tempo').innerText,
        eficacias: { eo: eoStr, ed: edStr, gr: grStr },
        historico: historico.slice(0, 30).map(e => ({
            t: e.t, cam: String(e.cam || e.j), a: e.a, z: e.z, zb: e.zb || "-"
        })),
        stats: Object.entries(jogadores)
            .filter(([k]) => !['TREINADOR','DIRIGENTE'].includes(k))
            .filter(([,j]) => (j.gm||0)+(j.rf||0)+(j.ft||0)+(j.ad||0)+(j.rd||0)+(j.gs||0)+(j.am||0)+(j.m2||0)+(j.vm||0) > 0)
            .map(([,j]) => ({
                cam: String(j.camisola||'?'), cipa: j.cipa, isGR: j.isGR||false,
                gm:j.gm||0, rf:j.rf||0, ad:j.ad||0, ft:j.ft||0,
                m7s:j.m7s||0, m7c:j.m7c||0, rd:j.rd||0, gs:j.gs||0,
                am:j.am||0, m2:j.m2||0, vm:j.vm||0,
                eo: calcPct(j.gm||0, (j.gm||0)+(j.rf||0)+(j.ft||0))
            })),
        ts: Date.now()
    };
    window._fbSet('jogo', payload).catch(e => console.warn('Firebase:', e));
}

function resetUI() { 
    jAtivo = null; zAtiva = null; 
    document.querySelectorAll('.btn-jogador, .btn-staff').forEach(b => b.classList.remove('selecionado')); 
    document.querySelectorAll('.btn-zona').forEach(b => { b.style.background = 'var(--azul)'; b.style.color = 'white'; }); 
    atualizarLabel(); 
}

function exportarCSV() { _exportarCSV(); }

function enviarWhatsApp() { _enviarWhatsApp(); }

function anularUltimo() { 
    if(historico.length > 0) { 
        const u = historico.shift();
        const j = jogadores[u.j];
        if(u.a === "Golo Marcado") j.gm--;
        else if(u.a === "Remate Falhado") j.rf--;
        else if(u.a === "A√ß√£o Defensiva") j.ad--;
        else if(u.a === "Falha T√©cnica") j.ft--;
        else if(u.a === "7M Sofrido") j.m7s--;
        else if(u.a === "7M Cometido") j.m7c--;
        else if(u.a === "C. Amarelo") j.am--;
        else if(u.a === "2 Minutos") j.m2--;
        else if(u.a === "C. Vermelho") j.vm--;
        else if(u.a === "Remate Defendido") j.rd--;
        else if(u.a === "Golo Sofrido") j.gs--;
        atualizarTudo(); 
    } 
}

let jogoInfo = {};
function carregarSetup(){const s=localStorage.getItem('handball_jogo_info');if(s){jogoInfo=JSON.parse(s);aplicarSetup();document.getElementById('modal-setup').style.display='none';}else{const n=new Date();document.getElementById('s-data').value=n.toISOString().split('T')[0];document.getElementById('s-hora').value=n.toTimeString().slice(0,5);document.getElementById('modal-setup').style.display='flex';}}
function guardarSetup(){const nos=document.getElementById('s-nos').value.trim(),eles=document.getElementById('s-eles').value.trim(),data=document.getElementById('s-data').value;if(!nos||!eles)return alert("Preenche o nome das duas equipas!");if(!data)return alert("Indica a data!");jogoInfo={id:document.getElementById('s-id').value.trim()||'?',data,hora:document.getElementById('s-hora').value,local:document.getElementById('s-local').value.trim()||'‚Äî',nos,eles};localStorage.setItem('handball_jogo_info',JSON.stringify(jogoInfo));aplicarSetup();document.getElementById('modal-setup').style.display='none';if(window._fbReady)window._fbSet('jogo/info',jogoInfo).catch(()=>{});}
function aplicarSetup(){document.getElementById('label-nos').innerText=jogoInfo.nos||'N√ìS';document.getElementById('label-eles').innerText=jogoInfo.eles||'ELES';const df=jogoInfo.data?new Date(jogoInfo.data+'T12:00').toLocaleDateString('pt-PT',{day:'2-digit',month:'short',year:'numeric'}):'';const p=[jogoInfo.id!=='?'?'Jogo #'+jogoInfo.id:'',df,jogoInfo.hora,jogoInfo.local!=='‚Äî'?jogoInfo.local:''].filter(Boolean);const b=document.getElementById('barra-jogo');b.innerText=p.join('  ¬∑  ');b.style.display='block';document.title=jogoInfo.nos+' vs '+jogoInfo.eles;}
function abrirEditarJogo(){document.getElementById('s-id').value=jogoInfo.id||'';document.getElementById('s-data').value=jogoInfo.data||'';document.getElementById('s-hora').value=jogoInfo.hora||'';document.getElementById('s-local').value=jogoInfo.local!=='‚Äî'?jogoInfo.local||'':'';document.getElementById('s-nos').value=jogoInfo.nos||'';document.getElementById('s-eles').value=jogoInfo.eles||'';document.getElementById('modal-setup').style.display='flex';}
function _exportarCSV(){let csv="\uFEFF";csv+=`Jogo #${jogoInfo.id||'?'};${jogoInfo.nos||'N√≥s'} vs ${jogoInfo.eles||'Eles'};${jogoInfo.data||''};${jogoInfo.hora||''};${jogoInfo.local||''}\n\n`;csv+="Tempo;Camisola;CIPA;Acao;Zona;Zona Baliza\n";historico.slice().reverse().forEach(e=>{const c=(jogadores[e.j]&&jogadores[e.j].cipa)?jogadores[e.j].cipa:"-";csv+=`${e.t};${e.cam||e.j};${c};${e.a};${e.z};${e.zb||"-"}\n`;});const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`scout_${(jogoInfo.nos||'nos').replace(/\s/g,'_')}_vs_${(jogoInfo.eles||'eles').replace(/\s/g,'_')}.csv`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);}
function _enviarWhatsApp(){if(historico.length===0)return alert("Sem registos!");let msg="*‚õæ SCOUT HANDBALL*\n";if(jogoInfo.nos)msg+=`*${jogoInfo.nos} vs ${jogoInfo.eles}*\n`;if(jogoInfo.data){const df=new Date(jogoInfo.data+'T12:00').toLocaleDateString('pt-PT');msg+=`üìÖ ${df}${jogoInfo.hora?' '+jogoInfo.hora:''}${jogoInfo.local&&jogoInfo.local!=='‚Äî'?' ‚Äî '+jogoInfo.local:''}\n`;}msg+=`\n*Marcador:* ${document.getElementById('p-nos').innerText} - ${document.getElementById('p-eles').innerText} _(${document.getElementById('tempo').innerText})_\n`;msg+=`*EO:* ${document.getElementById('eo-val').innerText} | *ED:* ${document.getElementById('ed-val').innerText} | *GR:* ${document.getElementById('gr-val').innerText}\n\n*√öltimas A√ß√µes:*\n`;historico.slice(0,10).forEach(e=>{msg+=`[${e.t}] ${e.cam||e.j} - ${e.a}`;if(e.zb&&e.zb!=="-")msg+=` (Baliza: ${e.zb})`;msg+="\n";});window.open("https://wa.me/?text="+encodeURIComponent(msg),'_blank');}
window.addEventListener('load',carregarSetup);
</script>
</body>
</html>